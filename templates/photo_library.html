{% extends "base.html" %}

{% block title %}Photo Library{% endblock %}

{% block header %}üì∏ Smart Photo Library{% endblock %}

{% block content %}


<div class="container-fluid py-4">
    <div class="page">
    <!-- USB Import Section -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-8">
            <div class="usb-status">
                <div id="usbStatusIcon" class="usb-icon">üíæ</div>
                <h3 id="usbStatusText">Ready to Import Photos</h3>
                <p class="text-muted mb-4">Insert a USB drive with photos to get started</p>
                <button class="btn btn-gradient-success touch-btn" onclick="scanForUSB()" style="min-width: 300px;">
                    üîç Scan for USB Drive
                </button>
                
                <div class="mt-3">
                    <button class="btn btn-gradient-warning touch-btn" onclick="forceMountUSB()" style="min-width: 250px;">
                        üîß Force Mount USB
                    </button>
                </div>
                
                <!-- USB Debug Panel -->
                <div class="usb-debug mt-3" id="usbDebugPanel" style="display: none;">
                    <h6>üîß USB Debug Information</h6>
                    <div id="debugInfo">Click "Show Debug Info" to see USB detection details</div>
                    <button class="debug-btn" onclick="showDebugInfo()">Show Debug Info</button>
                    <button class="debug-btn" onclick="checkMountPoints()">Check Mount Points</button>
                    <button class="debug-btn" onclick="listMediaDevices()">List /media</button>
                </div>
                
                <div class="mt-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleDebug()">
                        üîß Toggle Debug Panel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Folder Selection -->
    <div class="row mb-4" id="folderSelection" style="display: none;">
        <div class="col-12">
            <div class="text-center mb-4">
                <h3>üìÅ Choose Destination Folder</h3>
                <p class="text-muted">Select where to save your imported photos</p>
            </div>
            <div id="folderButtons" class="d-flex flex-wrap justify-content-center"></div>
            <div class="text-center">
                <button class="btn btn-gradient-warning folder-btn" onclick="createNewFolder()">
                    ‚ûï Create New Folder
                </button>
            </div>
        </div>
    </div>
    
    <!-- Photo Library Display -->
    <div id="photosContainer"></div>

    <!-- Library Manager -->
    <div class="panel" style="margin-top: 24px;">
        <div class="panel-title">Manage Library</div>
        <div class="section-note">Tap photos to select, then delete in bulk.</div>
        <div class="grid grid-3" id="libraryManagerGrid"></div>
        <div class="grid grid-3" style="margin-top: 12px;">
            <button class="btn btn-outline w-100" onclick="selectAllSaved()">Select All</button>
            <button class="btn btn-outline w-100" onclick="clearSavedSelection()">Clear</button>
            <button class="btn btn-danger w-100" onclick="deleteSelectedSaved()">Delete Selected</button>
        </div>
    </div>
    </div>
</div>

<!-- USB Import Modal -->
<div class="modal fade" id="usbImportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 20px; border: none;">
            <div class="modal-header" style="background: var(--primary-gradient); color: white; border-radius: 20px 20px 0 0;">
                <h5 class="modal-title">üñºÔ∏è Select Photos from USB</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <button class="btn btn-gradient-primary touch-btn" onclick="toggleSelectAll()">
                        ‚úÖ Select All / None
                    </button>
                    <span class="selected-count">0 photos selected</span>
                </div>
                
                <div id="loadingIndicator" class="text-center" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Loading USB photos...</p>
                </div>
                
                <div id="usbPhotosGrid" class="usb-photo-grid">
                    <!-- USB photos will be loaded here -->
                </div>
                
                <div class="import-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="selected-count" id="footerCount">0 photos selected</span>
                        <div>
                            <button class="btn btn-secondary touch-btn me-3" data-bs-dismiss="modal">‚ùå Cancel</button>
                            <button class="btn btn-gradient-success touch-btn" onclick="importSelectedPhotos()">
                                üì• Import Selected Photos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Folder Modal -->
<div class="modal fade" id="newFolderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 20px; border: none;">
            <div class="modal-header" style="background: var(--warning-gradient); color: white; border-radius: 20px 20px 0 0;">
                <h5 class="modal-title">üìÅ Create New Folder</h5>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <input type="text" id="folderNameInput" class="form-control touch-btn" placeholder="Folder name will appear here" readonly style="font-size: 24px; text-align: center;">
                </div>
                
                <div id="virtualKeyboard">
                    <div class="row g-1 mb-2">
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('1')">1</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('2')">2</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('3')">3</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('4')">4</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('5')">5</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('6')">6</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('7')">7</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('8')">8</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('9')">9</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('0')">0</button></div>
                    </div>
                    <div class="row g-1 mb-2">
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('Q')">Q</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('W')">W</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('E')">E</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('R')">R</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('T')">T</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('Y')">Y</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('U')">U</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('I')">I</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('O')">O</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('P')">P</button></div>
                    </div>
                    <div class="row g-1 mb-2">
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('A')">A</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('S')">S</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('D')">D</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('F')">F</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('G')">G</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('H')">H</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('J')">J</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('K')">K</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('L')">L</button></div>
                    </div>
                    <div class="row g-1 mb-2">
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('Z')">Z</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('X')">X</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('C')">C</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('V')">V</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('B')">B</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('N')">N</button></div>
                        <div class="col"><button class="keyboard-btn w-100" onclick="addChar('M')">M</button></div>
                        <div class="col-2"><button class="keyboard-btn w-100" onclick="backspace()" style="background: var(--danger-gradient); color: white;">‚å´</button></div>
                    </div>
                    <div class="row g-1">
                        <div class="col-3"><button class="keyboard-btn w-100" onclick="addChar(' ')">Space</button></div>
                        <div class="col-3"><button class="keyboard-btn w-100" onclick="addChar('_')">_</button></div>
                        <div class="col-3"><button class="keyboard-btn w-100" onclick="addChar('-')">-</button></div>
                        <div class="col-3"><button class="keyboard-btn w-100" onclick="clearAll()" style="background: var(--warning-gradient); color: white;">Clear</button></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary touch-btn" data-bs-dismiss="modal">‚ùå Cancel</button>
                <button type="button" class="btn btn-gradient-success touch-btn" onclick="saveNewFolder()">‚úÖ Create Folder</button>
            </div>
        </div>
    </div>
</div>

<!-- Saved Photo Preview Modal -->
<div class="modal fade" id="savedPhotoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Photo Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="savedPhotoImg" src="" alt="Saved photo" style="max-width: 100%; max-height: 60vh; border-radius: 12px;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global Variables
    let selectedFolder = '';
    let selectedPhotos = new Set();
    let usbPhotos = [];
    let folders = [];
    let savedPhotos = [];
    let selectedSaved = new Set();
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadLibrary();
        setTimeout(scanForUSB, 1000);
        setInterval(periodicUSBScan, 10000);
        
        // Initialize drag scrolling for touch devices
        initializeDragScrolling();
    });
    
    // Initialize drag scrolling functionality
    function initializeDragScrolling() {
        const scrollableElements = [
            '.modal-body',
            '.usb-photo-grid', 
            '.photo-library-grid',
            '.usb-debug'
        ];
        
        scrollableElements.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
                if (element) {
                    enableDragScroll(element);
                }
            });
        });
        
        // Re-initialize when modals are shown
        document.addEventListener('shown.bs.modal', function(e) {
            const modalBody = e.target.querySelector('.modal-body');
            if (modalBody) {
                enableDragScroll(modalBody);
                
                // Also enable for elements inside the modal
                const gridElements = modalBody.querySelectorAll('.usb-photo-grid');
                gridElements.forEach(grid => enableDragScroll(grid));
            }
        });
    }
    
    // Enable drag scrolling for an element
    function enableDragScroll(element) {
        let isDown = false;
        let startY;
        let scrollTop;
        let startX;
        let scrollLeft;
        
        // Mouse events
        element.addEventListener('mousedown', (e) => {
            // Don't interfere with buttons and other interactive elements
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || 
                e.target.closest('button') || e.target.closest('input')) {
                return;
            }
            
            isDown = true;
            element.style.cursor = 'grabbing';
            startY = e.pageY - element.offsetTop;
            scrollTop = element.scrollTop;
            startX = e.pageX - element.offsetLeft;
            scrollLeft = element.scrollLeft;
            e.preventDefault();
        });
        
        element.addEventListener('mouseleave', () => {
            isDown = false;
            element.style.cursor = 'grab';
        });
        
        element.addEventListener('mouseup', () => {
            isDown = false;
            element.style.cursor = 'grab';
        });
        
        element.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            
            const y = e.pageY - element.offsetTop;
            const walkY = (y - startY) * 2;
            element.scrollTop = scrollTop - walkY;
            
            const x = e.pageX - element.offsetLeft;
            const walkX = (x - startX) * 2;
            element.scrollLeft = scrollLeft - walkX;
        });
        
        // Touch events for mobile/tablet
        let touchStartY, touchStartX;
        
        element.addEventListener('touchstart', (e) => {
            // Don't interfere with buttons and other interactive elements
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || 
                e.target.closest('button') || e.target.closest('input')) {
                return;
            }
            
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
            scrollTop = element.scrollTop;
            scrollLeft = element.scrollLeft;
        }, { passive: true });
        
        element.addEventListener('touchmove', (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || 
                e.target.closest('button') || e.target.closest('input')) {
                return;
            }
            
            const touchY = e.touches[0].clientY;
            const touchX = e.touches[0].clientX;
            const walkY = touchStartY - touchY;
            const walkX = touchStartX - touchX;
            
            element.scrollTop = scrollTop + walkY;
            element.scrollLeft = scrollLeft + walkX;
        }, { passive: true });
    }
    
    // Load photo library
    function loadLibrary() {
        fetch('/api/photo-library/manage', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(data => {
            folders = data.data.folders;
            updateLibraryView(data.data);
            loadSavedPhotos();
        })
        .catch(err => console.error('Error loading library:', err));
    }
    
    // Update library view
    function updateLibraryView(data) {
        updateFolderButtons(data.folders);
        displayPhotos(data);
    }
    
    // Update folder buttons
    function updateFolderButtons(folderList) {
        const folderButtons = document.getElementById('folderButtons');
        folderButtons.innerHTML = '';
        
        folderList.forEach(folder => {
            const btn = document.createElement('button');
            btn.className = `btn folder-btn ${selectedFolder === folder ? 'active' : 'btn-outline-primary'}`;
            btn.innerHTML = `üìÅ ${folder}`;
            btn.onclick = () => selectFolder(folder);
            folderButtons.appendChild(btn);
        });
    }
    
    // Select folder
    function selectFolder(folder) {
        selectedFolder = folder;
        document.getElementById('folderSelection').style.display = 'block';
        updateFolderButtons(folders);
        
        document.querySelector('.usb-status').scrollIntoView({ 
            behavior: 'smooth',
            block: 'center'
        });
    }
    
    // Display photos in library
    function displayPhotos(data) {
        const photosContainer = document.getElementById('photosContainer');
        photosContainer.innerHTML = '';
        
        if (data.folders.length === 0) {
            photosContainer.innerHTML = `
                <div class="text-center usb-status">
                    <div class="usb-icon">üì∑</div>
                    <h3>No Photo Folders Yet</h3>
                    <p class="text-muted">Create your first folder and start importing photos!</p>
                </div>
            `;
            return;
        }
        
        const libraryTitle = document.createElement('div');
        libraryTitle.className = 'text-center mb-5';
        libraryTitle.innerHTML = '<h2>üìö Your Photo Library</h2>';
        photosContainer.appendChild(libraryTitle);
        
        const gridContainer = document.createElement('div');
        gridContainer.className = 'photo-library-grid';
        photosContainer.appendChild(gridContainer);
        
        data.folders.forEach(folder => {
            const folderSection = document.createElement('div');
            folderSection.className = 'folder-section';
            
            const folderPhotos = Object.entries(data.photos).filter(([photo, pFolder]) => pFolder === folder);
            const photoCount = folderPhotos.length;
            
            folderSection.innerHTML = `
                <div class="folder-header">üìÅ ${folder} (${photoCount} photos)</div>
                <div class="folder-photos" id="folder-${folder}"></div>
            `;
            
            gridContainer.appendChild(folderSection);
            
            const folderPhotosDiv = document.getElementById(`folder-${folder}`);
            folderPhotos.slice(0, 6).forEach(([photo, pFolder]) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'mb-3';
                photoDiv.innerHTML = `
                    <img src="/photos/albums/${folder}/${photo}" class="mini-photo" alt="${photo}" onclick="previewSavedPhoto('/photos/albums/${folder}/${photo}')">
                    <button class="btn btn-gradient-danger btn-sm touch-btn w-100" onclick="deletePhoto('${photo}')">
                        üóëÔ∏è Delete
                    </button>
                `;
                folderPhotosDiv.appendChild(photoDiv);
            });
            
            if (photoCount > 6) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'text-center text-muted';
                moreDiv.innerHTML = `<small>... and ${photoCount - 6} more photos</small>`;
                folderPhotosDiv.appendChild(moreDiv);
            }
        });
    }

    function loadSavedPhotos() {
        fetch('/api/photo-library/list-saved')
            .then(res => res.json())
            .then(data => {
                if (!data.success) return;
                savedPhotos = data.photos || [];
                renderSavedManager();
            })
            .catch(() => {});
    }

    function renderSavedManager() {
        const grid = document.getElementById('libraryManagerGrid');
        if (!grid) return;
        grid.innerHTML = '';
        savedPhotos.forEach((photo, idx) => {
            const card = document.createElement('div');
            card.className = 'photo-card' + (selectedSaved.has(idx) ? ' selected' : '');
            card.innerHTML = `
                <img src="${photo.url}" alt="${photo.name}">
                <div class="select-overlay">‚úì</div>
                <div class="p-2 small text-truncate">${photo.folder}/${photo.name}</div>
            `;
            card.onclick = () => {
                if (selectedSaved.has(idx)) selectedSaved.delete(idx);
                else selectedSaved.add(idx);
                renderSavedManager();
            };
            grid.appendChild(card);
        });
    }

    function selectAllSaved() {
        selectedSaved = new Set(savedPhotos.map((_, i) => i));
        renderSavedManager();
    }

    function clearSavedSelection() {
        selectedSaved.clear();
        renderSavedManager();
    }

    function deleteSelectedSaved() {
        if (selectedSaved.size === 0) return;
        if (!confirm(`Delete ${selectedSaved.size} photo(s)? This cannot be undone.`)) return;
        const toDelete = Array.from(selectedSaved).map(i => savedPhotos[i].name);
        const deletePromises = toDelete.map(name => fetch('/api/photo-library/manage', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'delete_photo', photo: name})
        }));
        Promise.all(deletePromises).then(() => {
            selectedSaved.clear();
            loadLibrary();
        });
    }
    
    // Scan for USB drives
    function scanForUSB() {
        const statusIcon = document.getElementById('usbStatusIcon');
        const statusText = document.getElementById('usbStatusText');
        
        statusIcon.innerHTML = 'üîç';
        statusIcon.classList.add('pulse-animation');
        statusText.textContent = 'Scanning for USB drives...';
        
        fetch('/api/photo-library/scan-usb')
            .then(res => res.json())
            .then(data => {
                statusIcon.classList.remove('pulse-animation');
                
                if (data.found) {
                    statusIcon.innerHTML = '‚úÖ';
                    statusText.textContent = `USB Drive Found: ${data.name}`;
                    
                    if (!selectedFolder) {
                        document.getElementById('folderSelection').style.display = 'block';
                        statusText.innerHTML += '<br><small class="text-muted">Please select a destination folder first</small>';
                    } else {
                        setTimeout(() => showUSBImport(), 1000);
                    }
                } else {
                    statusIcon.innerHTML = '‚ùå';
                    statusText.innerHTML = `
                        No USB drive found<br>
                        <small class="text-muted">Make sure your USB is FAT32 formatted and properly inserted</small>
                    `;
                    
                    // Show debug info automatically when USB not found
                    document.getElementById('usbDebugPanel').style.display = 'block';
                    showDebugInfo();
                    
                    setTimeout(() => {
                        statusIcon.innerHTML = 'üíæ';
                        statusText.textContent = 'Ready to Import Photos';
                    }, 5000);
                }
            })
            .catch(err => {
                statusIcon.classList.remove('pulse-animation');
                statusIcon.innerHTML = '‚ö†Ô∏è';
                statusText.innerHTML = `
                    Error scanning for USB drives<br>
                    <small class="text-muted">Check the debug panel below for details</small>
                `;
                document.getElementById('usbDebugPanel').style.display = 'block';
                document.getElementById('debugInfo').innerHTML = `<strong>Error:</strong> ${err.message}`;
                console.error('USB scan error:', err);
            });
    }
    
    // Periodic USB scanning
    function periodicUSBScan() {
        if (document.getElementById('usbStatusIcon').innerHTML === 'üíæ') {
            scanForUSB();
        }
    }
    
    // Toggle debug panel
    function toggleDebug() {
        const panel = document.getElementById('usbDebugPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
        fetch('/api/photo-library/debug-usb')
            .then(res => res.json())
            .then(data => {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.innerHTML = `
                    <strong>USB Detection Debug:</strong><br>
                    ‚Ä¢ Checked paths: ${data.checked_paths ? data.checked_paths.join(', ') : 'None'}<br>
                    ‚Ä¢ Existing paths: ${data.existing_paths ? data.existing_paths.join(', ') : 'None'}<br>
                    ‚Ä¢ Mounted paths: ${data.mounted_paths ? data.mounted_paths.join(', ') : 'None'}<br>
                    ‚Ä¢ Accessible paths: ${data.accessible_paths ? data.accessible_paths.length : 0}<br>
                    ‚Ä¢ udisks2 installed: ${data.udisks2_installed ? 'Yes' : 'No'}<br>
                    ‚Ä¢ Last scan: ${new Date().toLocaleTimeString()}<br>
                    <br><strong>Mount output:</strong><br>
                    <pre style="font-size: 10px; max-height: 150px; overflow-y: auto;">${data.mount_output || 'No mount info'}</pre>
                `;
            })
    // Show debug information
    function showDebugInfo() {
        fetch('/api/photo-library/debug-usb')
            .then(res => res.json())
            .then(data => {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.innerHTML = `
                    <strong>USB Detection Debug:</strong><br>
                    ‚Ä¢ Detected device: ${data.detected_device || 'None'}<br>
                    ‚Ä¢ Filesystem: ${data.filesystem_type || 'Unknown'}<br>
                    ‚Ä¢ Current mount: ${data.current_mount || 'Not mounted'}<br>
                    ‚Ä¢ Checked paths: ${data.checked_paths ? data.checked_paths.join(', ') : 'None'}<br>
                    ‚Ä¢ Existing paths: ${data.existing_paths ? data.existing_paths.join(', ') : 'None'}<br>
                    ‚Ä¢ Mounted paths: ${data.mounted_paths ? data.mounted_paths.join(', ') : 'None'}<br>
                    ‚Ä¢ Accessible paths: ${data.accessible_paths ? data.accessible_paths.length : 0}<br>
                    ${data.mount_attempt_result ? 
                        `‚Ä¢ Mount attempt: ${data.mount_attempt_result.message}<br>` : ''
                    }
                    ‚Ä¢ Last scan: ${new Date().toLocaleTimeString()}<br>
                    <br><strong>lsblk output:</strong><br>
                    <pre style="font-size: 10px; max-height: 150px; overflow-y: auto;">${data.lsblk_output || 'No lsblk info'}</pre>
                `;
            })
            .catch(err => {
                document.getElementById('debugInfo').innerHTML = `<strong>Debug Error:</strong> ${err.message}`;
                console.error('Debug error:', err);
            });
    }
    
    // Check mount points
    function checkMountPoints() {
        fetch('/api/photo-library/check-mounts')
            .then(res => res.json())
            .then(data => {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.innerHTML = `
                    <strong>Current Mount Points:</strong><br>
                    ${data.mounts ? data.mounts.slice(0, 10).map(m => `‚Ä¢ ${m}`).join('<br>') : '‚Ä¢ No mounts found'}<br>
                    <br><strong>USB-like mounts:</strong><br>
                    ${data.usbMounts ? data.usbMounts.map(m => `‚Ä¢ ${m}`).join('<br>') : '‚Ä¢ No USB mounts detected'}<br>
                    <br><small>Showing first 10 mounts only</small>
                `;
            })
            .catch(err => {
                document.getElementById('debugInfo').innerHTML = `<strong>Mount Check Error:</strong> ${err.message}`;
                console.error('Mount check error:', err);
            });
    }
    
    // List media devices
    function listMediaDevices() {
        fetch('/api/photo-library/list-media')
            .then(res => res.json())
            .then(data => {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.innerHTML = `
                    <strong>/media directory contents:</strong><br>
                    ${data.media && data.media.length > 0 ? data.media.map(m => `‚Ä¢ ${m}`).join('<br>') : '‚Ä¢ /media is empty'}<br>
                    <br><strong>/mnt directory contents:</strong><br>
                    ${data.mnt && data.mnt.length > 0 ? data.mnt.map(m => `‚Ä¢ ${m}`).join('<br>') : '‚Ä¢ /mnt is empty'}<br>
                    <br><strong>Manual mount commands to try:</strong><br>
                    ‚Ä¢ sudo mount /dev/sda1 /mnt/usb<br>
                    ‚Ä¢ sudo chmod 755 /mnt/usb<br>
                    ‚Ä¢ ls -la /mnt/usb/
                `;
            })
            .catch(err => {
                document.getElementById('debugInfo').innerHTML = `<strong>Media List Error:</strong> ${err.message}`;
                console.error('Media list error:', err);
            });
    }
    
    // Force mount USB
    function forceMountUSB() {
        const statusIcon = document.getElementById('usbStatusIcon');
        const statusText = document.getElementById('usbStatusText');
        
        statusIcon.innerHTML = 'üîß';
        statusIcon.classList.add('pulse-animation');
        statusText.textContent = 'Force mounting USB drive...';
        
        fetch('/api/photo-library/force-mount', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(data => {
            statusIcon.classList.remove('pulse-animation');
            
            if (data.success) {
                statusIcon.innerHTML = '‚úÖ';
                statusText.innerHTML = `
                    USB Force Mounted Successfully!<br>
                    <small class="text-muted">${data.message}</small>
                `;
                
                // Auto-scan after successful mount
                setTimeout(() => scanForUSB(), 1000);
            } else {
                statusIcon.innerHTML = '‚ùå';
                statusText.innerHTML = `
                    Force Mount Failed<br>
                    <small class="text-muted">${data.error}</small>
                `;
                
                // Show debug info on failure
                document.getElementById('usbDebugPanel').style.display = 'block';
                showDebugInfo();
            }
        })
        .catch(err => {
            statusIcon.classList.remove('pulse-animation');
            statusIcon.innerHTML = '‚ö†Ô∏è';
            statusText.innerHTML = `
                Force Mount Error<br>
                <small class="text-muted">${err.message}</small>
            `;
            console.error('Force mount error:', err);
        });
    }
    
    // Show USB import modal
    function showUSBImport() {
        if (!selectedFolder) {
            alert('Please select a destination folder first!');
            return;
        }
        
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('usbPhotosGrid').style.display = 'none';
        
        const modal = new bootstrap.Modal(document.getElementById('usbImportModal'));
        modal.show();
        
        fetch('/api/photo-library/list-usb')
            .then(res => res.json())
            .then(data => {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('usbPhotosGrid').style.display = 'grid';
                
                usbPhotos = data.photos;
                displayUSBPhotos(data.photos);
            })
            .catch(err => {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('usbPhotosGrid').innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center;">
                        <div class="usb-icon">‚ö†Ô∏è</div>
                        <h4>Error Loading USB Photos</h4>
                        <p class="text-muted">Please check if the USB drive is properly connected</p>
                    </div>
                `;
                console.error('USB photos error:', err);
            });
    }
    
    // Display USB photos
    function displayUSBPhotos(photos) {
        const grid = document.getElementById('usbPhotosGrid');
        grid.innerHTML = '';
        
        if (photos.length === 0) {
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center;">
                    <div class="usb-icon">üì∑</div>
                    <h4>No Photos Found</h4>
                    <p class="text-muted">No image files found on the USB drive</p>
                </div>
            `;
            return;
        }
        
        photos.forEach((photo, index) => {
            const photoCard = document.createElement('div');
            photoCard.className = 'photo-card';
            photoCard.onclick = () => togglePhotoSelection(index);
            photoCard.innerHTML = `
                <img src="/api/photo-library/usb-preview/${encodeURIComponent(photo.name)}" 
                     alt="${photo.name}" 
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE0MCIgdmlld0JveD0iMCAwIDIwMCAxNDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTQwIiBmaWxsPSIjZjVmNWY1Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iNzAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSI+SW1hZ2UgTm90IEZvdW5kPC90ZXh0Pgo8L3N2Zz4K'">
                <div class="select-overlay">‚úì</div>
                <div class="p-2 text-center small text-truncate" title="${photo.name}">${photo.name}</div>
            `;
            grid.appendChild(photoCard);
        });
        
        updateSelectedCount();
    }
    
    // Toggle photo selection
    function togglePhotoSelection(index) {
        const photoCard = document.querySelectorAll('.photo-card')[index];
        if (selectedPhotos.has(index)) {
            selectedPhotos.delete(index);
            photoCard.classList.remove('selected');
        } else {
            selectedPhotos.add(index);
            photoCard.classList.add('selected');
        }
        updateSelectedCount();
    }
    
    // Toggle select all photos
    function toggleSelectAll() {
        if (selectedPhotos.size === usbPhotos.length) {
            // Deselect all
            selectedPhotos.clear();
            document.querySelectorAll('.photo-card').forEach(card => {
                card.classList.remove('selected');
            });
        } else {
            // Select all
            selectedPhotos.clear();
            usbPhotos.forEach((_, index) => selectedPhotos.add(index));
            document.querySelectorAll('.photo-card').forEach(card => {
                card.classList.add('selected');
            });
        }
        updateSelectedCount();
    }
    
    // Update selected count display
    function updateSelectedCount() {
        const count = selectedPhotos.size;
        const countText = `${count} photos selected`;
        document.querySelector('.selected-count').textContent = countText;
        const footerCount = document.getElementById('footerCount');
        if (footerCount) {
            footerCount.textContent = countText;
        }
    }
    
    // Import selected photos
    function importSelectedPhotos() {
        if (selectedPhotos.size === 0) {
            alert('Please select at least one photo to import!');
            return;
        }
        
        const selectedPhotoNames = Array.from(selectedPhotos).map(index => usbPhotos[index].name);
        
        // Show loading state
        const importBtn = document.querySelector('[onclick="importSelectedPhotos()"]');
        const originalText = importBtn.innerHTML;
        importBtn.innerHTML = '‚è≥ Importing...';
        importBtn.disabled = true;
        
        fetch('/api/photo-library/import-usb', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                folder: selectedFolder,
                photos: selectedPhotoNames
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('usbImportModal')).hide();
                selectedPhotos.clear();
                
                // Update USB status
                document.getElementById('usbStatusIcon').innerHTML = '‚úÖ';
                document.getElementById('usbStatusText').textContent = `Successfully imported ${selectedPhotoNames.length} photos!`;
                
                // Reload library
                loadLibrary();
                
                // Reset status after a few seconds
                setTimeout(() => {
                    document.getElementById('usbStatusIcon').innerHTML = 'üíæ';
                    document.getElementById('usbStatusText').textContent = 'Ready to Import Photos';
                }, 5000);
            } else {
                alert('Error importing photos: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => {
            alert('Error importing photos: ' + err.message);
            console.error('Import error:', err);
        })
        .finally(() => {
            importBtn.innerHTML = originalText;
            importBtn.disabled = false;
        });
    }
    
    // Delete photo
    function deletePhoto(photo) {
        if (confirm('üóëÔ∏è Are you sure you want to delete this photo?\n\nThis action cannot be undone.')) {
            fetch('/api/photo-library/manage', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'delete_photo', photo})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    loadLibrary();
                } else {
                    alert('Error deleting photo: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                alert('Error deleting photo: ' + err.message);
                console.error('Delete error:', err);
            });
        }
    }
    
    // Create new folder
    function createNewFolder() {
        document.getElementById('folderNameInput').value = '';
        new bootstrap.Modal(document.getElementById('newFolderModal')).show();
    }
    
    // Save new folder
    function saveNewFolder() {
        const folderName = document.getElementById('folderNameInput').value.trim();
        if (!folderName) {
            alert('Please enter a folder name!');
            return;
        }
        
        if (folders.includes(folderName)) {
            alert('A folder with this name already exists!');
            return;
        }
        
        fetch('/api/photo-library/create-folder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({folder: folderName})
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('newFolderModal')).hide();
                loadLibrary();
                setTimeout(() => selectFolder(folderName), 500);
            } else {
                alert('Error creating folder: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => {
            alert('Error creating folder: ' + err.message);
            console.error('Create folder error:', err);
        });
    }
    
    // Virtual keyboard functions
    function addChar(char) {
        const input = document.getElementById('folderNameInput');
        input.value += char;
    }
    
    function backspace() {
        const input = document.getElementById('folderNameInput');
        input.value = input.value.slice(0, -1);
    }
    
    function clearAll() {
        document.getElementById('folderNameInput').value = '';
    }

    // Preview saved photo
    function previewSavedPhoto(src) {
        const modalEl = document.getElementById('savedPhotoModal');
        const imgEl = document.getElementById('savedPhotoImg');
        if (!modalEl || !imgEl) return;
        imgEl.src = src;
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }
</script>
{% endblock %}
